var w=Object.defineProperty;var g=(o,e,s)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var c=(o,e,s)=>g(o,typeof e!="symbol"?e+"":e,s);import{a as k,V as f}from"./index-DCiH_xld.js";class I{constructor(e){c(this,"workers",[]);c(this,"queue",[]);c(this,"activeTasks",new Map);c(this,"nextTaskId",1);for(let s=0;s<e;s++){const t=new Worker(new URL(""+new URL("aiWorker-BkP-zbzM.js",import.meta.url).href,import.meta.url),{type:"module"});this.workers.push(t),t.onmessage=r=>{const{taskId:i,result:a,isComplete:u}=r.data,n=this.queue.find(h=>h.taskId===i);n&&n.onResponse(a,u),u&&(this.activeTasks.delete(i),this.workers.push(t),this.processQueue())},t.onerror=r=>{console.error("Worker 处理任务失败:",r),this.workers.push(t),this.processQueue()}}}execute(e,s,t,r,i){const a=this.nextTaskId++;this.queue.push({taskId:a,messages:e,userApiKey:s,model:t,API_URL:r,onResponse:i}),this.processQueue()}processQueue(){if(this.queue.length>0&&this.workers.length>0){const e=this.workers.pop(),{taskId:s,messages:t,userApiKey:r,model:i,API_URL:a,onResponse:u}=this.queue.shift();this.activeTasks.set(s,e);try{const n=JSON.parse(JSON.stringify(t));e.postMessage({taskId:s,messages:n,userApiKey:r,model:i,API_URL:a}),console.log(`任务${s}分配给 Worker:${e}`),e.onmessage=h=>{const{taskId:d,result:m,isComplete:l}=h.data;u(m,l),l&&(this.activeTasks.delete(d),this.workers.push(e),this.processQueue())}}catch{u("数据传输失败",!0),this.workers.push(e),this.processQueue()}}}terminate(){this.workers.forEach(e=>e.terminate()),this.workers=[],this.activeTasks.clear()}}const p=f(),v=k(()=>p.aliApiUrl),T=k(()=>p.aliApiKey),y=k(()=>p.modelName),A=new I(4);async function q(o,e){A.execute(o,T.value,y.value,v.value,e)}export{q as s};
